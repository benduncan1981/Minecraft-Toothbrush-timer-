<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Oscar's Tooth Quest Elite</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
  html,body{height:100%;}
  body{
    font-family:Nunito,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:#000; color:#f5f5f5; overflow:hidden;
  }
  canvas#bg{
    position:fixed; left:0; top:0; width:100%; height:100%; image-rendering:pixelated; z-index:0;
  }
  .ui-root{position:relative;z-index:10;display:flex;justify-content:center;padding:18px;}
  .panel{
    width:420px; max-width:94vw; background:#1b1209; border:6px solid #000; padding:16px; box-shadow:0 12px 0 #000;
  }
  .title{font-family:'Press Start 2P',monospace;color:#fdf5d0;text-align:center;margin-bottom:6px;font-size:14px;text-shadow:3px 3px #000;}
  .timer{font-family:'Press Start 2P',monospace;text-align:center;font-size:26px;margin:8px 0;color:#fff;text-shadow:4px 4px #000;}
  .timer.low{color:#ff6666;}
  .mouth{width:220px;height:140px;margin:8px auto;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:6px;}
  .biome{border:4px solid #000;border-radius:4px;overflow:hidden;background:#222;position:relative;box-shadow:0 4px 0 #000;}
  .biome canvas{width:100%;height:100%;display:block;}
  .biome-label{position:absolute;left:6px;bottom:6px;font-family:'Press Start 2P',monospace;font-size:9px;color:#fdf5d0;text-shadow:2px 2px #000;}
  .biome.active{box-shadow:0 0 0 3px rgba(255,255,255,0.12),0 4px 0 #000;}
  .xp-bar{height:18px;background:#1a1a1a;border:4px solid #000;overflow:hidden;position:relative;margin-top:10px;}
  .xp-fill{height:100%;width:0;background:linear-gradient(90deg,#3adf4a,#7CFC00);transition:width .2s ease;}
  .btn-row{display:flex;gap:8px;margin-top:12px;}
  button{flex:1;padding:10px;font-family:'Press Start 2P',monospace;background:#5e3716;color:#fdf5d0;border:4px solid #000;box-shadow:0 4px 0 #000;cursor:pointer;}
  button:active{transform:translateY(2px);box-shadow:0 2px 0 #000;}
  .stats{font-size:12px;color:#f0e0b5;margin-top:12px;line-height:1.3;}
  @media (max-width:480px){ .mouth{width:200px;height:120px;} .panel{padding:12px;} .timer{font-size:22px;} }
</style>
</head>
<body>
<canvas id="bg"></canvas>

<div class="ui-root">
  <div class="panel" role="application" aria-label="Tooth Quest">
    <div class="title">Oscar's Tooth Quest Elite</div>
    <div class="timer" id="timer">02:00</div>

    <div class="mouth" aria-hidden="false">
      <div class="biome" data-index="0"><canvas class="biome-canvas"></canvas><div class="biome-label">Grasslands</div></div>
      <div class="biome" data-index="1"><canvas class="biome-canvas"></canvas><div class="biome-label">Stone Hills</div></div>
      <div class="biome" data-index="2"><canvas class="biome-canvas"></canvas><div class="biome-label">Desert</div></div>
      <div class="biome" data-index="3"><canvas class="biome-canvas"></canvas><div class="biome-label">Snow Peaks</div></div>
    </div>

    <div class="xp-bar" aria-hidden="false"><div id="xpFill" class="xp-fill"></div></div>

    <div class="btn-row">
      <button id="startBtn">Start Quest</button>
      <button id="resetBtn" style="display:none;">Restart</button>
    </div>

    <div class="stats" id="stats"></div>
  </div>
</div>

<script>
/* ====== Setup ====== */
const bg = document.getElementById('bg');
const bgCtx = bg.getContext('2d');
let DPR = Math.max(1, window.devicePixelRatio || 1);

/* ====== Resize background ====== */
function resizeBg(){
  DPR = Math.max(1, window.devicePixelRatio || 1);
  bg.width = Math.round(window.innerWidth * DPR);
  bg.height = Math.round(window.innerHeight * DPR);
  bg.style.width = window.innerWidth + 'px';
  bg.style.height = window.innerHeight + 'px';
  bgCtx.setTransform(DPR,0,0,DPR,0,0);
  drawBackground();
}
window.addEventListener('resize', resizeBg);
resizeBg();

/* ====== Clouds ====== */
let clouds = [];
function initClouds(){
  clouds = [];
  for(let i=0;i<6;i++){
    clouds.push({x:Math.random()*window.innerWidth, y:40+Math.random()*120, speed:0.2+Math.random()*0.4, w:40+Math.random()*60});
  }
}
initClouds();

/* ====== Background draw ====== */
function drawBackground(){
  const h = new Date().getHours();
  const isNight = (h>=20 || h<6);
  const top = isNight ? '#050816' : '#6ec5ff';
  const bottom = isNight ? '#0a1020' : '#9ad8ff';
  const g = bgCtx.createLinearGradient(0,0,0,window.innerHeight*0.6);
  g.addColorStop(0, top);
  g.addColorStop(1, bottom);
  bgCtx.fillStyle = g;
  bgCtx.fillRect(0,0,window.innerWidth,window.innerHeight);

  // sun/moon
  bgCtx.save();
  bgCtx.translate(window.innerWidth - 80, 80);
  bgCtx.fillStyle = isNight ? '#f5f5ff' : '#ffe27a';
  bgCtx.beginPath(); bgCtx.arc(0,0,26,0,Math.PI*2); bgCtx.fill();
  bgCtx.restore();

  // clouds
  bgCtx.fillStyle = isNight ? '#cfd6ff' : '#ffffff';
  clouds.forEach(c=>{
    c.x += c.speed;
    if(c.x > window.innerWidth + 80) c.x = -120;
    drawPixelCloud(c.x, c.y, c.w);
  });

  // ground
  const groundH = window.innerHeight * 0.28;
  const baseY = window.innerHeight - groundH;
  bgCtx.fillStyle = '#3b2a16';
  bgCtx.fillRect(0, baseY, window.innerWidth, groundH);
  const block = 24;
  for(let x=0;x<window.innerWidth;x+=block){
    for(let y=baseY;y<window.innerHeight;y+=block){
      drawBlock(x,y,block,'#4b341c','#3b2a16');
    }
  }
  // grass strip
  bgCtx.fillStyle = '#3f8f2b';
  bgCtx.fillRect(0, baseY - 22, window.innerWidth, 22);
  for(let x=0;x<window.innerWidth;x+=block) drawBlockTop(x, baseY-22, block, '#4caf34', '#2f6f1f');
}

function drawPixelCloud(x,y,w){
  const h = Math.round(w*0.6);
  const step = 8;
  for(let i=0;i<w;i+=step){
    for(let j=0;j<h;j+=step){
      if(Math.random()>0.25) bgCtx.fillRect(Math.round(x+i), Math.round(y+j), step, step);
    }
  }
}
function drawBlock(x,y,size,top,side){
  bgCtx.fillStyle = side; bgCtx.fillRect(x,y,size,size);
  bgCtx.fillStyle = top; bgCtx.fillRect(x,y,size,size-4);
}
function drawBlockTop(x,y,size,top,shadow){
  bgCtx.fillStyle = top; bgCtx.fillRect(x,y,size,18);
  bgCtx.fillStyle = shadow; bgCtx.fillRect(x,y+14,size,4);
}

/* ====== Particles ====== */
let particles = [];
function spawnParticle(x,y,color){
  particles.push({x,y,vx:(Math.random()-0.5)*2,vy:-1.5-Math.random()*1.5,life:50+Math.random()*30,color,size:2+Math.random()*4});
}
function burstParticlesAtCanvas(x,y,color,count=60){
  for(let i=0;i<count;i++) spawnParticle(x + (Math.random()-0.5)*40, y + (Math.random()-0.5)*40, color);
}
function updateParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.life--;
    if(p.life<=0) particles.splice(i,1);
  }
}
function drawParticles(){
  particles.forEach(p=>{
    bgCtx.fillStyle = p.color;
    bgCtx.fillRect(Math.round(p.x), Math.round(p.y), p.size, p.size);
    bgCtx.fillStyle = 'rgba(0,0,0,0.25)';
    bgCtx.fillRect(Math.round(p.x), Math.round(p.y+p.size-1), p.size, 1);
  });
}

/* ====== Biomes ====== */
const biomeEls = Array.from(document.querySelectorAll('.biome'));
const biomeCanvases = biomeEls.map(el => el.querySelector('.biome-canvas'));
function resizeBiomeCanvases(){
  const ratio = DPR;
  biomeCanvases.forEach((c, idx)=>{
    const rect = c.getBoundingClientRect();
    c.width = Math.round(rect.width*ratio);
    c.height = Math.round(rect.height*ratio);
    const bctx = c.getContext('2d');
    bctx.setTransform(ratio,0,0,ratio,0,0);
    drawBiome(bctx, rect.width, rect.height, idx);
  });
}
window.addEventListener('resize', ()=>{ resizeBg(); resizeBiomeCanvases(); });
resizeBiomeCanvases();

function drawBiome(bctx, w, h, index){
  bctx.imageSmoothingEnabled = false;
  bctx.clearRect(0,0,w,h);
  const block = Math.max(6,Math.floor(w/8));
  let palette;
  if(index===0) palette={top:'#4caf34',mid:'#3b2a16',acc:'#2f6f1f'};
  else if(index===1) palette={top:'#9ea7b8',mid:'#6c7484',acc:'#4b5260'};
  else if(index===2) palette={top:'#f2d28b',mid:'#d1b06a',acc:'#b8944f'};
  else palette={top:'#f5f7ff',mid:'#cfd6e8',acc:'#a9b3cc'};

  const cols = Math.ceil(w/block), rows = Math.ceil(h/block);
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      const px=x*block, py=y*block;
      let color=(y===0)?palette.top:(Math.random()<0.12?palette.acc:palette.mid);
      bctx.fillStyle=color; bctx.fillRect(px,py,block,block);
      bctx.fillStyle='rgba(0,0,0,0.22)';
      bctx.fillRect(px,py+block-3,block,3);
    }
  }
}

/* ====== Timer & UI ====== */
const totalTime=120, timerEl=document.getElementById('timer'), xpFill=document.getElementById('xpFill'), startBtn=document.getElementById('startBtn'), resetBtn=document.getElementById('resetBtn'), statsEl=document.getElementById('stats');
let timeLeft=totalTime, timerInterval=null, running=false;
let save;
try{ save=JSON.parse(localStorage.getItem('toothQuestElite')||'null')||{totalMinutes:0,streak:0,lastDate:null}; }catch(e){ save={totalMinutes:0,streak:0,lastDate:null}; }
function saveData(){ localStorage.setItem('toothQuestElite', JSON.stringify(save)); }
function formatTime(t){ const m=Math.floor(t/60),s=t%60; return (m<10?'0':'')+m+':'+(s<10?'0':'')+s; }
function updateStatsUI(){
  const level = Math.floor(save.totalMinutes/10)+1;
  statsEl.innerHTML=`<div><strong>Level ${level}</strong> Â· World Builder</div>
    <div>Total brushing time: <strong>${save.totalMinutes}</strong> minutes</div>
    <div>Daily streak: <strong>${save.streak}</strong> day${save.streak===1?'':'s'}</div>`;
}
updateStatsUI();

/* ====== Audio helper ====== */
let audioCtx=null;
function playBleep(freq=880,dur=0.08){
  try{
    if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='square'; o.frequency.value=freq;
    g.gain.setValueAtTime(0.12,audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime+dur);
  }catch(e){ console.warn('Audio blocked', e); }
}

/* ====== Game tick ====== */
function gameTick(){
  timeLeft--;
  if(timeLeft<0){ finishQuest(); return; }
  timerEl.textContent=formatTime(timeLeft);
  timerEl.classList.toggle('low', timeLeft<=10);

  const progress=(totalTime-timeLeft)/totalTime;
  const percent=Math.round(progress*100);
  xpFill.style.width=percent+'%';

  const quadIndex=Math.min(3,Math.floor(progress*4));
  biomeEls.forEach(b=>b.classList.remove('active'));
  if(quadIndex>=0&&quadIndex<4){
    const el=biomeEls[quadIndex]; el.classList.add('active');
    const rect=el.getBoundingClientRect(), bgRect=bg.getBoundingClientRect();
    const cx=(rect.left+rect.width/2)-bgRect.left, cy=(rect.top+rect.height/2)-bgRect.top;
    burstParticlesAtCanvas(cx*DPR, cy*DPR, '#7CFC00', 8);
  }

  playBleep(660,0.04);
}

/* ====== Finish ====== */
function finishQuest(){
  clearInterval(timerInterval); timerInterval=null; running=false; timeLeft=0;
  timerEl.textContent='00:00'; timerEl.classList.remove('low');

  save.totalMinutes+=2;
  const today=new Date().toDateString();
  if(save.lastDate!==today){ save.streak++; save.lastDate=today; }
  saveData(); updateStatsUI();

  biomeEls.forEach(b=>b.classList.remove('active'));
  startBtn.style.display='none'; resetBtn.style.display='inline-block'; startBtn.disabled=false;

  const bgRect=bg.getBoundingClientRect();
  burstParticlesAtCanvas((bgRect.width/2)*DPR,(bgRect.height/2)*DPR,'#7CFC00',120);
  try{ if(navigator.vibrate) navigator.vibrate([200,100,200]); }catch(e){}
  playBleep(880,0.12); setTimeout(()=>playBleep(1320,0.12),90);
}

/* ====== Buttons ====== */
startBtn.addEventListener('click', ()=>{
  if(running) return;
  running=true; timeLeft=totalTime; timerEl.textContent=formatTime(timeLeft);
  xpFill.style.width='0%'; startBtn.disabled=true; resetBtn.style.display='none';
  timerInterval=setInterval(gameTick,1000);
  try{ if(navigator.vibrate) navigator.vibrate(80); }catch(e){}
  playBleep(520,0.08);
});
resetBtn.addEventListener('click', ()=>{
  running=false; clearInterval(timerInterval); timerInterval=null;
  timeLeft=totalTime; timerEl.textContent=formatTime(timeLeft); xpFill.style.width='0%';
  biomeEls.forEach(b=>b.classList.remove('active'));
  startBtn.style.display='inline-block'; resetBtn.style.display='none'; startBtn.disabled=false;
});

/* ====== Animation loop ====== */
function loop(){ drawBackground(); updateParticles(); drawParticles(); requestAnimationFrame(loop); }
loop();

setTimeout(()=>{ try{ resizeBiomeCanvases(); }catch(e){ console.error('biome init failed', e); } },120);
console.info('Tooth
